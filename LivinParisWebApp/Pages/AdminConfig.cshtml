@page
@model LivinParisWebApp.Pages.AdminConfigModel
@{
	Layout = "~/Pages/Shared/_LayoutVoidNavBar.cshtml";
	ViewData["Title"] = "Panel Admin";
}
<head>
	<link rel="stylesheet" href="/css/site.css" />
</head>
<div class="admin-container">
	<div class="top">
		<div class="formulaire-container">
			<form method="post" class="formulaire-btns">
				<button type="submit" asp-page-handler="LoadStationInBDD"><p>Charger la BDD avec les stations</p></button>
				<button type="submit" asp-page-handler="DeleteContenuStations"><p>Vider la table Station</p></button>
				<button type="submit" asp-page-handler="GenererGraphe"><p>Générer le graphe</p></button>
				<button type="submit" asp-page-handler="GenererGraphe2"><p>Générer le graphe 2</p></button>
				<button type="submit" asp-page-handler="VoidBDD"><p>Vider la BDD pour rendu final</p></button>
			</form>
		</div>
		<div class="stats-container">
			<p class="stats-title">Statistiques de la base de données</p>
			<div class="stats">
				<div class="nb-cmd stat">
					<p class="stat-title rose">Nombre de commandes client :</p>
					@foreach (var item in Model.ClientsCommandes)
					{
						<p>Client @item.ID_client : @item.Nb_commandes commande(s)</p>
					}
				</div>
				<div class="client-cmd stat">
					<p class="stat-title rose">Clients avec plusieurs commandes :</p>
					@foreach (var item in Model.ClientsActifs)
					{
						<p>Client @item.ID_client : @item.Nb_commandes commande(s)</p>
					}
				</div>
				<div class="cuis-dispo stat">
					<p class="stat-title rose">Cuisiniers disponibles :</p>
					@foreach (var item in Model.CuisiniersDispos)
					{
						<p>Cuisinier @item.ID_cuisinier</p>
					}
				</div>
				<div class="best-plat stat">
					<p class="stat-title rose">Plat le plus commandé :</p>
					@if (Model.PlatLePlusCommande?.Any() == true)
					{
						var plat = Model.PlatLePlusCommande.First();
						<span>@plat.Nom (@plat.Fois_commande fois)</span>
					}
					else
					{
						<span>Aucun plat trouvé</span>
					}
				</div>
				<div class="cmd-sans-plat stat">
					<p class="stat-title rose">Commandes sans plat abordable :</p>
					@foreach (var item in Model.CommandesSansPlatAbordable)
					{
						<p>Commande @item.ID_commande</p>
					}
				</div>
				<div class="cuis-sans-cmd stat">
					<p class="stat-title rose">Cuisiniers sans commande :</p>
					@foreach (var item in Model.CuisiniersDispos)
					{
						<p>Cuisinier @item.ID_cuisinier</p>
					}
				</div>
			</div>
		</div>
	</div>
	<div class="bottom">
		<div class="img-container">
			<div class="graphe-dijkstra">
				<p>Visualisation du graphe complet + 1 chemin Dijkstra</p>
				<div class="map-container">
					<div id="map"></div>
				</div>
			</div>
			<div class="graphe-coloration">
				<p>Coloration Welsh-Powell (Clients-Cuisinier-Commandes)</p>
				<div class="map-container">
					<div id="map2"></div>
				</div>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

	<script src="https://d3js.org/d3.v7.min.js"></script>

	<script>
		const ligneColors = {
			1: "#FFCD00", 
			2: "#003CA6", 
			3: "#837902", 
			"3bis": "#6EC4E8",
			4: "#CF009E", 
			5: "#FF7E2E", 
			6: "#6ECEB2", 
			7: "#F5A9BB",
			"7bis": "#6ECA97", 
			8: "#E19BDF", 
			9: "#B6BD00", 
			10: "#C9910D",
			11: "#704B1C", 
			12: "#007852", 
			13: "#99D4E4", 
			14: "#62259D"
		};


		const chemin = @Html.Raw(Model.CheminJson)

		const stations = @Html.Raw(ViewData["Stations"])

		const arcs = @Html.Raw(ViewData["Arcs"])

		//carte
		const map = L.map('map').setView([48.8566, 2.3522], 12);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '© OpenStreetMap contributors'
		}).addTo(map);

		//Ajout des stations
		const stationMap = {};
		stations.forEach(st => {
			stationMap[st.id] = st;

			const marker = L.circleMarker([st.Latitude, st.Longitude], {
				radius: 5,
				fillColor: "#ff5e5e",
				color: "#000",
				weight: 1,
				opacity: 0.8,
				fillOpacity: 0.8
			}).addTo(map);
			marker.bindPopup(`<strong>${st.nom}</strong><br/>ID: ${st.id}`);
		});

		// Ajout des arcs
		arcs.forEach(arc => {
			const srcLat = arc.SourceLat;
			const srcLong = arc.SourceLong;
			const destLat = arc.DestLat;
			const destLong = arc.DestLong;
			const ligne = arc.Ligne;

			const color = ligneColors[ligne] || "#000";

			L.polyline([
				[srcLat, srcLong],
				[destLat, destLong]
			], {
				color: color,
				weight: 4,
				opacity: 0.8
			}).addTo(map);
		});

		// Affichage du chemin trouvé en noir
		if (chemin && chemin.length > 1) {
			// console.log("Coordonnées utilisées dans latlngs :", chemin.map(s => [s.Latitude, s.Longitude]));

			const latlngs = chemin.map(s => [parseFloat(s.Latitude), parseFloat(s.Longitude)]);

			L.polyline(latlngs, {
				color: 'black',
				weight: 6,
				opacity: 0.9
			}).addTo(map);
			//si on veut centrer sur le chemin dijsktra
			// map.fitBounds(L.polyline(latlngs).getBounds());
		} else {
			console.log("Aucun chemin trouvé ou chemin trop court.");
		}
		/// SURCOUCHE POSITIONS CUISINIERS ET CLIENTS ///
		//Récupérer les données Clients et Cuisiniers depuis Razor
		var clients = @Html.Raw(ViewData["Clients"]);
		var cuisiniers = @Html.Raw(ViewData["Cuisiniers"]);
		// Fonction pour ajouter un marqueur
	 	function ajouterMarqueur(lat, lng, texte) {
	 		L.marker([lat, lng]).addTo(map).bindPopup(texte);
		}
		// Ajouter les marqueurs pour les clients
	 	clients.forEach(function (client) {
	 		ajouterMarqueur(client.latitude, client.longitude, "Client ID: " + client.id);
	 	});

	 	// Ajouter les marqueurs pour les cuisiniers
	 	cuisiniers.forEach(function (cuisinier) {
	 		ajouterMarqueur(cuisinier.latitude, cuisinier.longitude, "Cuisinier ID: " + cuisinier.id);
	 	});
		/////////////////////////////////////////////////
    </script>

	<script>
		const map2 = L.map('map2').setView([48.8566, 2.3522], 12); // vue centrée sur Paris
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '© OpenStreetMap contributors'
		}).addTo(map2);

		// Récupération des données Razor
		const noeuds = @Html.Raw(ViewData["NoeudsJson"]);
		const liens = @Html.Raw(ViewData["LiensJson"]);

		// Couleurs par type de noeud
		const couleurs = {
			"Client": "#ff7f0e",
			"Commande": "#1f77b4",
			"Plat": "#2ca02c",
			"Cuisinier": "#d62728"
		};

		function decalerCoordonnees(lat, lon, index = 1) {
			const angle = Math.random() * 2 * Math.PI; // direction aléatoire
			const rayon = 0.005;
			return [
				lat + rayon * Math.cos(angle),
				lon + rayon * Math.sin(angle)
			];
		}

		// Ajout des marqueurs pour chaque nœud
		const noeudMap = {};
		noeuds.forEach((n, i) => {
			if (n.latitude !== 0 && n.longitude !== 0) {
				let lat = n.latitude;
				let lon = n.longitude;

				if (n.type === "Commande" || n.type === "Plat") {
					[lat, lon] = decalerCoordonnees(lat, lon, i); // décalage pour éviter la superposition
				}

				const marker = L.circleMarker([lat, lon], {
					radius: 6,
					color: "#000",
					fillColor: couleurs[n.type] || "#666",
					fillOpacity: 0.9,
					weight: 1
				}).addTo(map2);
				marker.bindPopup(`${n.type} : ${n.id}`);
				noeudMap[n.id] = [lat, lon];
			}
		});

		// Dessin des liens entre les nœuds
		liens.forEach(link => {
			const src = noeudMap[link.source];
			const dest = noeudMap[link.target];
			if (src && dest) {
				L.polyline([src, dest], {
					color: "#000",
					weight: 2,
					opacity: 0.6
				}).addTo(map2);
			}
		});
	</script>
}